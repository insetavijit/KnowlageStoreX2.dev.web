| **Subtopic** | **Focus & Purpose** | **Key Concepts / Details** | **One-Line Recall** |
| :--- | :--- | :--- | :--- |
| **2.7.4 Asset Aggregation** | Performance | Collecting fragment assets into one file; `webc:keep`; Buckets | Many parts -> One file. |
| **[[2.7.4.1 How Bundling Works]]** | Concept | Standard `<style>`/`<script>` tags are *moved* from component to bundle | It strips assets out. |
| **[[2.7.4.2 The Bundle Helper]]** | Output | `getCss(page.url)` and `getJs(page.url)`; Rendering the pile | Paste the assets here. |
| **[[2.7.4.3 Buckets]]** | Organization | `webc:bucket="defer"`; Creating multiple bundles (Critical vs Deferred) | Sort assets into piles. |
| **[[2.7.4.4 webc:keep]]** | Override | Prevents aggregation; Tag stays exactly where it was written | Leave this tag alone. |
| **[[2.7.4.5 External Files]]** | Strategy | `<link rel="stylesheet">` inside components is also aggregated | External files get bundled too. |

# 2.7.4 Asset Aggregation

A major problem with "Single File Components" in other systems is that it encourages you to write 50 small `<style>` blocks. If served as-is, the browser has to parse style rules 50 times, often blocking the render.

WebC solves this by **Aggregating** (moving) all styles and scripts effectively "up" to the layout, leaving only the clean HTML behind.

---

## 2.7.4.1 How Bundling Works

**Input (my-card.webc)**:
```html
<style> .card { color: red; } </style>
<script> console.log("Card"); </script>
<div class="card">Hello</div>
```

**Output (Page HTML)**:
```html
<div class="card">Hello</div>
```

Where did the style and script go? They were stripped out and placed into an internal "Bundle Map" for the current page.

---

## 2.7.4.2 The Bundle Helper

To see the assets, you must ask for them in your main layout file.

**layout.webc**:
```html
<!DOCTYPE html>
<html>
<head>
  <title>My Site</title>
  <!-- Render all collected CSS here -->
  <style @raw="getBundle('css')" webc:keep></style>
</head>
<body>
  <template @raw="content"></template>

  <!-- Render all collected JS here -->
  <script @raw="getBundle('js')" webc:keep></script>
</body>
</html>
```

*   `getBundle('css')`: Returns a giant string of all CSS from every component used on the page.
*   `webc:keep`: Tells WebC "Don't bundle this tag itself!" (Otherwise we'd have an infinite loop).

---

## 2.7.4.3 Buckets (Critical vs Defer)

You often want some CSS to be inline (Critical) and some to be loaded later (Defer). You can label your component assets with `webc:bucket`.

**heavy-chart.webc**:
```html
<style webc:bucket="charts"> 
  /* Huge CSS file */ 
</style>
<div class="chart">...</div>
```

**layout.webc**:
```html
<head>
  <!-- Main Bundle (Critical) -->
  <style @raw="getBundle('css')" webc:keep></style>
</head>
<body>
  ...
  <!-- Charts Bundle (Lazy) -->
  <style @raw="getBundle('css', 'charts')" webc:keep></style>
</body>
```

Any asset *without* a bucket goes to the default bundle.

---

## 2.7.4.4 webc:keep (The Escape Hatch)

Sometimes you specifically WANT a script to stay with the component (e.g., an inline click handler or a specific 3rd party tracker).

```html
<script webc:keep>
  alert("I stay right here in the DOM!");
</script>
```

This tag will be output exactly where it sits in the component HTML and will **not** be moved to the bundle.

---

## 2.7.4.5 External Files

Aggregation also works on external links.

**my-card.webc**:
```html
<link rel="stylesheet" href="card.css">
```

WebC will read `card.css`, inline its contents into the CSS bundle, and remove the `<link>` tag from the component output. This "Inline by default" strategy is incredibly performant for First Contentful Paint.

---

## Quick Reference

| Feature | Syntax | Result |
| :--- | :--- | :--- |
| **Default** | `<style>` | Moved to Default Bundle. |
| **Bucket** | `webc:bucket="x"` | Moved to Bundle "x". |
| **Keep** | `webc:keep` | Stays in Component output. |
| **Render** | `getBundle('type')` | Outputs contents of a bundle. |
| **External** | `<link href="...">` | Content read & bundled inline. |
