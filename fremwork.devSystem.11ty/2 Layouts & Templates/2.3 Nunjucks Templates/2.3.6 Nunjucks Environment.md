| **Subtopic** | **Focus & Purpose** | **Key Concepts / Details** | **One-Line Recall** |
| :--- | :--- | :--- | :--- |
| **2.3.6 Nunjucks Environment** | Engine Configuration | `setNunjucksEnvironmentOptions`; customization; extensions | Tuning the engine under the hood. |
| **[[2.3.6.1 Configuration Hook]]** | Setup | `eleventyConfig.setNunjucksEnvironmentOptions(options)` | Tweak Nunjucks settings. |
| **[[2.3.6.2 Autoescaping]]** | Security | Enabling/disabling HTML escaping (`autoescape: true/false`); safety | XSS prevention switch. |
| **[[2.3.6.3 Custom Tags (Extensions)]]** | Advanced | Adding custom tags `{% myTag %}`; `addNunjucksTag()` | Creating your own syntax. |
| **[[2.3.6.4 Async Filters]]** | Async Data | `addNunjucksAsyncFilter`; handling Promise-based data | Waiting for data in pipes. |
| **[[2.3.6.5 Loader Customization]]** | Low-Level | How Nunjucks finds files; `FileSystemLoader`; relative paths | Where Nunjucks looks for files. |

# 2.3.6 Nunjucks Environment

While Eleventy abstracts away most complexity, it allows you to access the underlying **Nunjucks Environment** to perform deep customizations. This is where you configure how the engine itself behaves, specifically regarding strings, whitespace, and custom syntax tags.

---

## 2.3.6.1 Configuration Hook

You can control the Nunjucks environment directly in your `.eleventy.js` (or `.eleventy.config.js`) file.

```javascript
module.exports = function(eleventyConfig) {
  eleventyConfig.setNunjucksEnvironmentOptions({
    throwOnUndefined: true,
    trimBlocks: true,
    lstripBlocks: true
  });
};
```

*   `trimBlocks`: Automatically removes the newline after a block tag (`{% %}`).
*   `lstripBlocks`: Automatically removes the whitespace before a block tag.
*   `throwOnUndefined`: Makes debugging easier by crashing if you use a variable that doesn't exist (instead of silently printing nothing).

---

## 2.3.6.2 Autoescaping

By default, Eleventy configures Nunjucks with `autoescape: false` (legacy reasons) or handling it contextually.

If you are strictly building an application where user input is displayed, you might want to force **Autoescaping**.

```javascript
eleventyConfig.setNunjucksEnvironmentOptions({
  autoescape: true
});
```

**Impact**: If enabled, `{{ "<h1>Hi</h1>" }}` outputs `&lt;h1&gt;Hi&lt;/h1&gt;`. You must then use the `| safe` filter for any trusted HTML.

---

## 2.3.6.3 Custom Tags (Extensions)

Beyond Filters (`{{ x | filter }}`) and Shortcodes (`{% shortcode %}`), you can add fully custom Nunjucks **Tags**. This allows you to create new syntax constructs, like `{% runcode %}...{% endruncode %}`.

```javascript
eleventyConfig.addNunjucksTag("uppercase", function(nunjucksEngine) {
  return new function() {
    this.tags = ["uppercase"];

    this.parse = function(parser, nodes, lexer) {
      var tok = parser.nextToken();
      var args = parser.parseSignature(null, true);
      parser.advanceAfterBlockEnd(tok.value);
      var body = parser.parseUntilBlocks("enduppercase");
      parser.advanceAfterBlockEnd();
      return new nodes.CallExtension(this, "run", args, [body]);
    };

    this.run = function(context, args, body) {
      return new nunjucksEngine.runtime.SafeString(body().toUpperCase());
    };
  }();
});
```

*Note: This is advanced territory. For 99% of use cases, Shortcodes (`addShortcode`) are sufficient and much easier to write.*

---

## 2.3.6.4 Async Filters

Standard Nunjucks filters are synchronous. However, Eleventy patches Nunjucks to support **Async Filters**, which is essential for fetching external data.

```javascript
eleventyConfig.addNunjucksAsyncFilter("getWeather", async function(city, callback) {
  let weather = await fetchWeatherApi(city);
  callback(null, weather.temp);
});
```

**Usage**:
```html
The temperature is {{ "London" | getWeather }}.
```

Eleventy pauses the rendering of that specific template until the Promise resolves.

---

## 2.3.6.5 Loader Customization

Nunjucks uses a "Loader" to find files on your disk. Eleventy provides its own custom loader to handle its specific file system rules (like handling input directories).

Generally, you should **not** mess with the Loader unless you are building a plugin. Changing the loader can break Eleventy's ability to find Includes and Layouts relative to the correct directories.

---

## Quick Reference

| Option | Effect |
| :--- | :--- |
| **trimBlocks** | Removes newlines after `{% %}` tags. Makes HTML cleaner. |
| **lstripBlocks** | Removes spaces before `{% %}` tags. Matches indentation. |
| **throwOnUndefined** | Best debugging tool. Errors if `{{ tyop }}` exists. |
| **addNunjucksTag** | Create completely custom syntax. (Use Shortcodes instead if possible). |
| **Async Filters** | Exclusive Eleventy feature enabling async data in pipes. |
