# Data Preprocessing: Transforming Raw Data

Raw API data is rarely in the ideal format for your templates. **Preprocessing** is the practice of transforming, filtering, and normalizing data before it reaches your templatesâ€”keeping your views clean and logic-free.

---

## The Fundamental Principle: ETL for Static Sites

Borrowing from database terminology:
- **Extract**: Fetch data from the source
- **Transform**: Clean, filter, reshape
- **Load**: Return the processed data

```javascript
module.exports = async function() {
  // 1. EXTRACT
  const raw = await fetch('https://api.example.com/posts').then(r => r.json());
  
  // 2. TRANSFORM
  const processed = raw
    .filter(post => post.status === 'published')
    .map(post => ({
      title: post.title,
      slug: post.slug,
      date: new Date(post.published_at),
      excerpt: post.content.substring(0, 150) + '...'
    }));
  
  // 3. LOAD
  return processed;
};
```

---

## Why Preprocess?

1. **Reduce Payload**: Discard fields you don't need (API returns 50 fields, you use 5)
2. **Normalize**: Convert inconsistent formats to a standard shape
3. **Compute**: Add derived fields (slugs, formatted dates)
4. **Filter**: Remove drafts, expired content, irrelevant items
5. **Clean Templates**: No complex logic in Nunjucks/Liquid

---

## Filtering Unwanted Data

APIs often return more than you need:

```javascript
// Remove drafts, archived posts, and future-dated content
const now = new Date();

const published = raw.filter(post => {
  return post.status === 'published'
    && !post.archived
    && new Date(post.date) <= now;
});
```

---

## Selecting Specific Fields

Reduce data size by keeping only needed fields:

```javascript
const minimal = raw.map(post => ({
  title: post.title,
  url: post.permalink,
  image: post.featured_image?.url,
  date: post.published_at
}));
```

---

## Normalizing Inconsistent Data

APIs from different sources have different structures:

```javascript
// Normalize to a common format
const normalized = raw.map(item => ({
  // Handle different field names
  title: item.title || item.name || item.heading,
  
  // Handle missing values
  author: item.author?.name || 'Anonymous',
  
  // Handle different date formats
  date: new Date(item.date || item.created_at || item.timestamp)
}));
```

---

## Computing Derived Fields

Add fields that are useful but not in the source:

```javascript
const enriched = raw.map(post => ({
  ...post,
  
  // Add a slug
  slug: post.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
  
  // Calculate read time
  readTime: Math.ceil(post.content.split(' ').length / 200),
  
  // Format date for display
  displayDate: new Date(post.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}));
```

---

## Grouping Data

Restructure flat arrays into grouped objects:

```javascript
// Group posts by year
const byYear = raw.reduce((acc, post) => {
  const year = new Date(post.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {});

// Result: { 2024: [...], 2023: [...] }
```

---

## Caching the Result

Combine preprocessing with caching for efficiency:

```javascript
const EleventyFetch = require("@11ty/eleventy-fetch");

module.exports = async function() {
  const raw = await EleventyFetch("https://api.example.com/posts", {
    duration: "1d",
    type: "json"
  });
  
  // Preprocessing runs every time, but fetch is cached
  return raw
    .filter(p => p.published)
    .map(p => ({ title: p.title, slug: p.slug }));
};
```

---

## Common Pitfalls and Solutions

**Problem:** Preprocessing is slow.

**Solution:** Cache the raw fetch. Preprocessing is typically fast; fetching is slow.

---

**Problem:** Template errors because field is missing.

**Solution:** Use optional chaining (`item?.field`) and provide defaults.

---

**Problem:** Data looks right in console but wrong in template.

**Solution:** Verify the final transformed structure. Use `JSON.stringify` to debug.

---

## Quick Reference

| Transform | Method | Example |
| :--- | :--- | :--- |
| **Filter** | `.filter()` | Remove drafts |
| **Select** | `.map()` | Keep only needed fields |
| **Normalize** | `item?.field \|\| default` | Handle missing data |
| **Group** | `.reduce()` | Group by category/year |
| **Sort** | `.sort()` | Order by date/title |

---

_This guide covers data preprocessing. Natural progressions include **computed data**, **custom filters**, and **build optimization**._
