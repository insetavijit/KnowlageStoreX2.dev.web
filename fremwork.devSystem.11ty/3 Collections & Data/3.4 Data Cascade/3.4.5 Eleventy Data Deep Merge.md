# Eleventy Data Deep Merge: Controlling Combination Behavior

The `setDataDeepMerge` configuration option is the single switch that determines whether Eleventy performs shallow or deep merging of data structures. Understanding it prevents frustrating array and object combination issues.

---

## The Fundamental Principle: Shallow vs Deep

**Shallow Merge:** Only the top-level keys are combined. Nested objects and arrays are replaced entirely.

**Deep Merge:** Objects at every level are combined recursively. Arrays are typically concatenated.

```javascript
// Shallow Merge
{ a: { x: 1 } } + { a: { y: 2 } } = { a: { y: 2 } }  // "a" replaced

// Deep Merge
{ a: { x: 1 } } + { a: { y: 2 } } = { a: { x: 1, y: 2 } }  // "a" merged
```

---

## Configuration

**Enable Deep Merge (Recommended for most projects):**

```javascript
// eleventy.config.js
module.exports = function(eleventyConfig) {
  eleventyConfig.setDataDeepMerge(true);
};
```

**Disable Deep Merge (Pre-1.0 default behavior):**

```javascript
eleventyConfig.setDataDeepMerge(false);
```

**Eleventy 2.0+ defaults to deep merge enabled.**

---

## Practical Impact: Tags Example

The most visible impact is on `tags`:

**Directory Data (`posts/posts.11tydata.json`):**
```json
{
  "tags": ["blog"]
}
```

**Content Front Matter:**
```yaml
---
tags:
  - featured
---
```

**With Deep Merge:**
```javascript
{ tags: ["blog", "featured"] }  // Combined
```

**Without Deep Merge:**
```javascript
{ tags: ["featured"] }  // Front matter replaces
```

Most users expect tags to combine, so deep merge is typically desired.

---

## Nested Object Behavior

Consider complex metadata:

**Global Data:**
```json
{
  "meta": {
    "og:type": "website",
    "twitter:card": "summary"
  }
}
```

**Content Front Matter:**
```yaml
---
meta:
  og:title: "My Page"
---
```

**With Deep Merge:**
```javascript
{
  meta: {
    "og:type": "website",
    "twitter:card": "summary",
    "og:title": "My Page"
  }
}
```

**Without Deep Merge:**
```javascript
{
  meta: {
    "og:title": "My Page"  // Only front matter keys
  }
}
```

Deep merge preserves the global defaults while allowing specific overrides.

---

## Array Concatenation

With deep merge enabled, arrays from different levels **concatenate**:

**Directory Data:**
```json
{
  "scripts": ["/js/main.js"]
}
```

**Content Front Matter:**
```yaml
---
scripts:
  - "/js/page-specific.js"
---
```

**Result:**
```javascript
{ scripts: ["/js/main.js", "/js/page-specific.js"] }
```

Be carefulâ€”this can lead to duplicate entries if the same script is listed at multiple levels.

---

## Preventing Duplication

If arrays are duplicating unwantedly:

**Option 1: Use computed data to deduplicate:**

```javascript
eleventyComputed: {
  scripts: (data) => [...new Set(data.scripts)]
}
```

**Option 2: Centralize array definitions in one layer only:**

Define all scripts in global data, and have content simply set a boolean flag like `includeCharts: true` that the layout interprets.

---

## Common Pitfalls and Solutions

**Problem:** Arrays have duplicate entries.

**Cause:** Deep merge concatenates arrays from multiple layers.

**Solution:** Deduplicate in computed data with `new Set()`, or restructure to avoid multi-layer arrays.

---

**Problem:** Nested objects unexpectedly have too many keys.

**Cause:** Deep merge combines all keys from all layers.

**Solution:** If you need a clean slate, explicitly set the entire object in the highest-priority layer (front matter).

---

**Problem:** Upgrading Eleventy changed merge behavior.

**Cause:** Default changed between versions.

**Solution:** Explicitly set `setDataDeepMerge(true)` or `false` in config for consistent behavior across upgrades.

---

## Quick Reference

| Setting | Object Behavior | Array Behavior |
| :--- | :--- | :--- |
| **Deep Merge OFF** | Shallow replace | Replace |
| **Deep Merge ON** | Recursive merge | Concatenate |
| **Tags** | Always merge keys | Always concatenate |

---

_This guide covers the deep merge configuration. Natural progressions include **computed data for post-merge cleanup**, **debugging merged structures**, and **version migration considerations**._
